name: Release Stable Version

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:  # Manuele trigger toegevoegd

permissions:
  contents: write    # ← VERANDERD: write i.p.v. read (voor commits)
  packages: write

jobs:
  release:
    runs-on: ubuntu-latest
    if: contains(github.ref, 'refs/tags/')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}  # ← TOEGEVOEGD: voor push permissies

      - name: Set up Java 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'

      - name: Extract version from Git tag
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Using version: $VERSION"

      - name: Update pom.xml to release version
        run: mvn versions:set -DnewVersion=$VERSION -DgenerateBackupPoms=false

      - name: Build and deploy to GitHub Packages
        run: mvn deploy -DskipTests
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Calculate next SNAPSHOT version
        run: |
          # Bump de patch version en voeg SNAPSHOT toe
          IFS='.' read -ra VERSION_PARTS <<< "$VERSION"
          MAJOR=${VERSION_PARTS[0]}
          MINOR=${VERSION_PARTS[1]}
          PATCH=${VERSION_PARTS[2]}
          NEXT_PATCH=$((PATCH + 1))
          NEXT_VERSION="$MAJOR.$MINOR.$NEXT_PATCH-SNAPSHOT"
          echo "NEXT_VERSION=$NEXT_VERSION" >> $GITHUB_ENV
          echo "Next SNAPSHOT version: $NEXT_VERSION"

      - name: Update to next SNAPSHOT version
        run: mvn versions:set -DnewVersion=$NEXT_VERSION -DgenerateBackupPoms=false

      - name: Commit and push next SNAPSHOT version
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add pom.xml
          git commit -m "ci: bump version to $NEXT_VERSION [skip ci]"
          git push

  verify:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'

      - name: Verify build
        run: mvn clean compile -DskipTests